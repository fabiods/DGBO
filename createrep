#!/bin/bash
gamma=$1
set -e
set -u

echo -n "                                           "
awk '{ printf "%5.3f     ",$2 }' bmax.dat
echo
sss=`tail -n 1 basrun.allene.$gamma.uniq.dat  | awk '{ for (i=4;i<=NF; i++) printf("%-10s",$i) }'`

awk '{print $1}' basrunsed.dat > tmpsed1
tail -n 1 basrun.allene.$gamma.uniq.dat  | awk '{ for (i=4;i<=NF; i++) {print $i} }' > tmpsed2
paste tmpsed1 tmpsed2 > basrunsed.dat
rm tmpsed1 tmpsed2
export GMF="%2.0E"
echo $gamma > gamma.info
~/DGBO/basdergmf.sh >basdergmf.out
notc=`tail -n 2 basdergmf.out | head -n 1`
mini=`tail -n 1 basdergmf.out` 

if [ "$gamma" != "0" ]; then
eee=`tail -n 1 basrun.allene.$gamma.uniq.dat | awk -v gg=$gamma '{ printf "%15.8f %15.8f %10.2f",$1,$2,exp($3/gg)}'`
else
eee=`tail -n 1 basrun.allene.$gamma.uniq.dat | awk -v gg=$gamma '{ printf "%15.8f %15.8f %10.2f",$1,$2,0}'`
fi

echo "$eee" "$sss" $notc $mini

sss=`tail -n 1 INC/basrun.allene.$gamma.uniq.dat   | awk '{ for (i=4;i<=NF; i++) printf("%-10s",$i) }'`

cd INC
awk '{print $1}' basrunsed.dat > tmpsed1
tail -n 1 basrun.allene.$gamma.uniq.dat   | awk '{ for (i=4;i<=NF; i++) { print $i} }' > tmpsed2
paste tmpsed1 tmpsed2 > basrunsed.dat
rm tmpsed1 tmpsed2
export GMF="%3.1E"
echo $gamma >gamma.info
~/DGBO/basdergmf.sh >basdergmf.out
notc=`tail -n 2 basdergmf.out | head -n 1`
mini=`tail -n 1 basdergmf.out` 
cd ..

if [ "$gamma" != "0" ]; then
eee=`tail -n 1 INC/basrun.allene.$gamma.uniq.dat | awk -v gg=$gamma '{ printf "%15.8f %15.8f %10.2f",$1,$2,exp($3/gg)}'`
else
eee=`tail -n 1 INC/basrun.allene.$gamma.uniq.dat | awk -v gg=$gamma '{ printf "%15.8f %15.8f %10.2f",$1,$2,0}'`
fi
echo "$eee" "$sss" $notc $mini

#basrun.allene is only created at the first run (gradientpara runs)

if [ -e INC/INC3/allene.$gamma.dat ]; then 
sss=`sort -k 1 -g -r  INC/INC3/allene.$gamma.dat | tail -n 1 | awk '{ for (i=4;i<=NF; i++) printf("%-10s",$i) }'`

cd INC/INC3
awk '{print $1}' basrunsed.dat > tmpsed1
tail -n 1 allene.$gamma.dat   | awk '{ for (i=4;i<=NF; i++) { print $i} }' > tmpsed2
paste tmpsed1 tmpsed2 > basrunsed.dat
rm tmpsed1 tmpsed2
export GMF="%4.2E"
echo $gamma > gamma.info
~/DGBO/basdergmf.sh >basdergmf.out
notc=`tail -n 2 basdergmf.out | head -n 1`
mini=`tail -n 1 basdergmf.out` 
cd ../..

if [ "$gamma" != "0" ]; then
eee=`sort -k 1 -g -r  INC/INC3/allene.$gamma.dat | tail -n 1 | awk -v gg=$gamma '{ printf "%15.8f %15.8f %10.2f",$1,$2,exp($3/gg)}'`
else
eee=`sort -k 1 -g -r  INC/INC3/allene.$gamma.dat | tail -n 1 | awk -v gg=$gamma '{ printf "%15.8f %15.8f %10.2f",$1,$2,0}'`
fi
echo "$eee" "$sss" $notc $mini
else
echo  "INC/INC3/allene.$gamma.dat not found"
fi

cd INC/INC3
if [ ! -d comp$gamma ]; then
 mkdir comp$gamma
fi
cd comp$gamma
cp ../basrunsed.dat .
cp ../inputhf.d12.par .
oldcell=`grep -A 2 "CRYSTALLOGRAPHIC CELL " ../inputhf.out  | tail -n 1 | awk '{print $1}'`
newcell=`echo $oldcell | awk '{print $1-0.1}'` 
echo $newcell
sed -i s/$oldcell/$newcell/g inputhf.d12.par
export BPROG=1.5
export GMF="%5.3E"
~/DGBO/basrun.sh 
cd ../../../
pwd
